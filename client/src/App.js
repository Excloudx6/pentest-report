import React, { Component } from 'react';
import './App.css';
import {Segment, Container, Menu, Button, Label } from 'semantic-ui-react'
import 'whatwg-fetch'
import {Redirect, Link,HashRouter, Route} from 'react-router-dom'
import {Pentest} from './screens/Pentest.js'
import {Login, LoginCheck} from './screens/login.js'
import {Pentests, NewPentest} from './screens/Pentests.js'
import {urlPrefix} from './utils.js'

//import update from 'immutability-helper'




// ---------------------

function LoggedInInfo(props) {
  if (!props.whoami) return <span>...</span>;

  const loggedIn = props.whoami.loggedIn;
  const skipLoginButtom = window.location.hash==='#/authentication';
  if (!loggedIn && !skipLoginButtom) return <Link to='/authentication'><Button primary>Sign-in</Button></Link>

  var username = '';
  if (loggedIn) {
    username = props.whoami.user.username ? props.whoami.user.username : props.whoami.user.shortName;
  return (
    <div>
    <Label as='a' image inverted='true'>
      <img alt='avatar' src='https://semantic-ui.com/images/avatar/small/elliot.jpg' />
      {username}
    </Label>
    <a href={urlPrefix+"/login/logout"} style={{"marginLeft": "15px"}}>logout</a></div>);
  }
  return null;
}

class MainMenu extends React.Component {
  render() {
    return (
    <div>
      <Segment inverted style={{"borderRadius": "0px"}}>
      <Menu inverted pointing secondary>
        <Link to='/'><Menu.Item name='pentests' active={true}/></Link>

        <Menu.Menu position='right'>
        <Menu.Item>
        <LoggedInInfo whoami={this.props.whoami}/>
        </Menu.Item>
        </Menu.Menu>
      </Menu>
      </Segment>
        <Container fluid className="Content">
            {this.props.children}
        </Container>
    </div>
    )
  }
}



// -----------------

class App extends Component {
  render() {

    return (
      <div className="App">
            <HashRouter>
            <LoginCheck skip={window.location.pathname==='/extensions/...'}>
            <MainMenu>
                <Route exact path='/' render={props => (
                    <Redirect to='/pentests/'/>
                )}/>


                
                <Route  path='/authentication' render={(props) =>{return (<LoginCheck><Login/></LoginCheck>)}}/>
                
                <Route  path='/pentests' component={Pentests}/>
                <Route  path='/newPentest' render={(props)=>
                  <LoginCheck skip={window.location.pathname==='/extensions/...'}>
                    <NewPentest {...props}/>
                  </LoginCheck> 
                }/>

                
                  <Route  path='/pentest/:code' render={(props)=>
                    <LoginCheck skip={window.location.pathname==='/extensions/...'}>
                      <Pentest {...props}/>
                    </LoginCheck> 
                  }/>

            </MainMenu>
            </LoginCheck>
            </HashRouter>

      </div>
    );
  }
}

export default App;
