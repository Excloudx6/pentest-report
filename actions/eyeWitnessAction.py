import http.client
import sys
import os
import subprocess
import re
from action import Action

class EyeWitnessAction(Action):
    def __init__(self):
        super().__init__('eye_witness', ['dirb_simple'])


    def run(self, actions):

        result = {}
        total = 0
        scanned = 0

        if(not 'urls' in actions['dirb_simple']['result']):
            return ({'status':'error', 'result': {}, 'error': 'No "urls" key in the dirb_simple results. Old dirb_simle version?'})

        total += len(actions['dirb_simple']['result']['urls'])

        urls = actions['dirb_simple']['result']['urls']
        path = self.getOutputPath()

        urls_text = str.join('\n', urls)

        with open(path + "hosts.txt", "w") as urls_file:
            print(urls_text, file=urls_file)
            urls_file.close()
        
        print('Scanning urls: \n' + urls_text)
        print(path+"/hosts.txt")
    
        stdout=subprocess.check_output('python3 ./EyeWitness/Python/EyeWitness.py -f ' + path + 'hosts.txt -d '+path+'eyewitness --results 1000 --no-prompt --web', shell=True).decode('iso_8859_1').splitlines()
        self.reportOutputFile('eyewitness/report.html')

        ret =  {'status': 'done', 'result': {'stdout': stdout}}
        return ret



a = EyeWitnessAction()
a.scan()
