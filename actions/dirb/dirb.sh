#!/bin/zsh

if [ $# -ne 1 ]; then
	echo "Runs dirb scanning against a single host"
	echo "Usage: dirb.sh baseurl"
    echo "e.g. dirb.sh https://foo.com:8080"
    echo 
    echo "NEVER RUN ON UNTRUSTED SERVER AS ROOT. Priv esc via symlink from /tmp to /etc possile."
	echo
	echo "2017-2018"
	exit
fi

u=$1
RAND=$RANDOM
#    echo "=======================------------------ scanning $u ---------------------"
	rm -f /tmp/dirb$RAND.txt /tmp/curl$RAND.txt

	# detect non HTTP ports to prevent dirb hangs
	touch /tmp/curl$RAND.txt
	curl "$u" --max-time 2 -o /tmp/curl$RAND.txt -s -i 

    # UGLY: Hardcoded 2 ports!!!
	if [[ -z `cat /tmp/curl$RAND.txt | grep HTTP/` || "$u" =~ :2301 || "$u" =~ :2381 ]] ; then
        ;
        #echo "Skipping: $u"
	else
		dirb "$u" ./wordlist.txt -r -S -o /tmp/dirb$RAND.txt -r -S 2>&1 > /dev/null
        touch /tmp/urls$RAND.txt
		cat /tmp/dirb$RAND.txt |  grep '+ http' | cut -d' ' -f 2 >> /tmp/urls$RAND.txt
        cat /tmp/dirb$RAND.txt |  grep ' DIRECTORY:' | cut -d' ' -f 3 >> /tmp/urls$RAND.txt
#		echo "--- scan DONE"
	fi
	
# at this stage ./tmp/urls.txt contains additional urls found
rm -f /tmp/urls_all$RAND.txt
cat /tmp/urls$RAND.txt > /tmp/urls_all$RAND.txt
echo $u >> /tmp/urls_all$RAND.txt
#echo "-------"
cat /tmp/urls_all$RAND.txt
