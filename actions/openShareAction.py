import http.client
import os
import subprocess
import sys
import re
from action import Action

class openShare(Action):
    def __init__(self):
        super().__init__('open_shares', ['full_scan_trigger'])

    def ignorePreviousruns(self):
        return False

    def run(self,actions):

        result = {}
        total = len(actions['_trigger']['params']['hosts'])
        scanned = 0

        for host in actions['_trigger']['params']['hosts']:
            
            host = host['ip']
            self.reportProgress({'percentage': 100*scanned/total, 'description' : '{}:{} (scanning: {})'.format(str(scanned), str(total), host)})
            print('Scanning host {}'.format(host))
            try:
                host = re.sub(r'[^a-zA-Z0-9_\.]','', host)
                scanresult = subprocess.check_output('showmount -e ' + host + '', shell=True, timeout = 10).decode('iso_8859_1').splitlines()
            except Exception:
                scanresult = None
            if not scanresult is None:
                result[host] = scanresult
                print(result)
            scanned += 1
            self.reportProgress({'percentage': 100*scanned/total, 'description': "{}/{} (scanning {})".format(str(scanned),str(total),host)})
        
        ret = {'status': 'done', 'result':{'hosts': result}}
        print(ret)
        return ret

a = openShare()
a.scan()
