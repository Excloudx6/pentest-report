import http.client
import sys
import os
from subprocess import Popen, PIPE
from action import Action
import re
import shlex

class WebScanner(Action):
    def __init__(self):
        super().__init__('webscanner', ['http_detection'])
   
    def ignorePreviousruns(self):
        return False

    def run(self,actions):
     
        result = {}
        total = len(actions['http_detection']['result']['hosts'])
        scanned = 0
  
        path = self.getOutputPath()
        
        for host,host_det in actions['http_detection']['result']['hosts'].items():
            self.reportProgress({'percentage': 100*scanned/total, 'description' : '{}:{} (scanning: {})'.format(str(scanned), str(total), host)})
            if 'tcp' in host_det:
                ports = []
                print(host_det['tcp'].items())
                for port, port_det in host_det['tcp'].items():
                    ports.append(port)
                ports = ','.join(str(p) for p in ports)
                print(ports)
                print('Scanning host {} on ports {}'.format(host, ports))
                cmd = shlex.split('perl /usr/bin/nikto -host ' + host + ' -port ' + ports + ' -Display V -output ' + path + 'nikto_' + host + '.html')
                nikto = Popen(cmd,stdout=PIPE)
                (out,err) = nikto.communicate()
 
                self.reportOutputFile('nikto_' + host + '.html')
                scanned +=1
                self.reportProgress({'percentage': 100*scanned/total, 'description': "{}/{} (scanning: {})".format(str(scanned),str(total),host)})

        ret = {'status': 'done', 'result': {}}
        return ret

a = WebScanner()
a.scan()
