version: '2'

### Creates a named network with the default bridge driver
# The network is shared between restheart and mongodb only
# See: https://docs.docker.com/engine/userguide/networking/dockernetworks/
# See: https://docs.docker.com/engine/reference/commandline/network_create/
       
### Uncomment to create a permanent, named data volume
# This makes much easier to identify where the mongodb data is stored on host
# See: https://docs.docker.com/engine/userguide/containers/dockervolumes/#mount-a-shared-storage-volume-as-a-data-volume
volumes:
    mongodatavolume-${ENV_SUFFIX}:
    actionfilesvolume-${ENV_SUFFIX}:

networks:
    internal-${ENV_SUFFIX}:

services:
    mongodb-${ENV_SUFFIX}:
        image: mongo:4
        container_name: mongo-${ENV_SUFFIX}
        networks:
            internal-${ENV_SUFFIX}:
               aliases:
                   - mongodb
        volumes:
         - mongodatavolume-${ENV_SUFFIX}:/data/db
        ${EXPOSE_MONGODB_PORTS}
        command: --auth
    node-${ENV_SUFFIX}:
        build: 
           context: ./node
           args:
              - PORT=${EXTERNAL_PORT}
              - http_proxy=${http_proxy}
              - https_proxy=${https_proxy}
        container_name: node-${ENV_SUFFIX}
        image: pentest-node-${ENV_SUFFIX}:pentest-node-${ENV_SUFFIX}
        ports:
         - "${EXTERNAL_PORT}:10443"
        networks:
         - internal-${ENV_SUFFIX}
        volumes:
         - actionfilesvolume-${ENV_SUFFIX}:/data/actionfiles
        ${DOCKER_NODE_DISABLED}

    actions-${ENV_SUFFIX}:
        build:
           context: ./actions
        container_name: actions-${ENV_SUFFIX}
        volumes:
         - actionfilesvolume-${ENV_SUFFIX}:/data/actionfiles
        image: pentest-actions-${ENV_SUFFIX}:pentest-actions-${ENV_SUFFIX}
        networks:
         - internal-${ENV_SUFFIX}



