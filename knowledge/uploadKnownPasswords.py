#!/usr/bin/python3
from pymongo import MongoClient
import time
import sys
import json
import os

class MongoConnector:
    def __init__(self):

        with open('mongo_password.txt', 'r') as myfile:
            self.__mongourl=myfile.read().replace('\n', '')

        print (self.__mongourl)
        urlsplit=self.__mongourl.split('/')

        self.__client = MongoClient(self.__mongourl)
        self.__db = self.__client[urlsplit[-1]]
        self.actions = self.__db.actions
        self.knowledge = self.__db.knowledge

        with open('pentest_id.txt', 'r') as idfile:
            self.pentest_id=idfile.read().replace('\n', '')

class PasswordUploader:
    def __init__(self):
        self.mongo = MongoConnector()

    def upload(self, userpass_filename):
        userpass = []
        with open(userpass_filename, 'r') as f:
            for line in f:
                l = line.strip().split(' ',1)
                if(len(l[0])>0 and len(l[1])>0):
                    userpass.append( [l[0], l[1]] )

        print('Uploading {} records.'.format(len(userpass)))

        # NOTE: replace done for now, but there's nothing against having duplicates/many lists.
        self.mongo.knowledge.replace_one({'pentest_id': self.mongo.pentest_id, 'type': 'known_userpass', 'purpose': 'ssh', 'source': 'manual_upload'}, {'pentest_id': self.mongo.pentest_id, 'type': 'known_userpass', 'purpose': 'ssh', 'source': 'manual_upload','data': userpass}, upsert=True)

        print('Done')
        print('All current known passwords:')
        print(str(list(self.mongo.knowledge.find({'pentest_id': self.mongo.pentest_id, 'type': 'known_userpass', 'purpose': 'ssh'}))))

if(len(sys.argv)!=2):
    print("Pass a filename with known usernames and passwords as an argument. Space separated lines (e.g. 'user pass').")
    sys.exit(1)

p = PasswordUploader()
p.upload(sys.argv[1])
